# ConsensusAI Backend

AIçµ±åˆã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹å½¢æˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API

## ğŸŒŸ æ¦‚è¦

ConsensusAI Backendã¯ã€æ„è¦‹åé›†ã¨AIåˆ†æã‚’æ´»ç”¨ã—ã¦ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹å½¢æˆã‚’æ”¯æ´ã™ã‚‹WebAPIã§ã™ã€‚è¤‡æ•°ã®AIãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ„è¦‹ã‚’è‡ªå‹•åˆ†æã—ã€ãƒˆãƒ”ãƒƒã‚¯åˆ†é¡ã‚„ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æã€ã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆã‚’è¡Œã„ã¾ã™ã€‚

### ä¸»ãªæ©Ÿèƒ½

- ğŸ¤– **AIçµ±åˆåˆ†æ**: OpenAI APIã‚’æ´»ç”¨ã—ãŸè‡ªå‹•ãƒˆãƒ”ãƒƒã‚¯åˆ†é¡
- ğŸ“Š **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æ**: WebSocketã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—é€šçŸ¥
- ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã¨å…¥åŠ›æ¤œè¨¼
- ğŸ“ˆ **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
- ğŸŒ **ãƒ‘ãƒ–ãƒªãƒƒã‚¯API**: èªè¨¼ä¸è¦ã®æ„è¦‹æŠ•ç¨¿æ©Ÿèƒ½
- ğŸ“ **è©³ç´°ãƒ­ã‚°**: æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### å‰ææ¡ä»¶

- Node.js 18+
- npm 8+
- OpenAI API Key

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
git clone <repository-url>
cd ConsensusAI/server

# è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
chmod +x scripts/setup.sh
./scripts/setup.sh
```

### ç’°å¢ƒè¨­å®š

`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦å¿…è¦ãªè¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ï¼š

```env
# Database
DATABASE_URL="file:./dev.db"

# OpenAI API
OPENAI_API_KEY="your_openai_api_key_here"

# Server
PORT=3000
NODE_ENV=development

# Security (æœ¬ç•ªç’°å¢ƒã®ã¿)
ALLOWED_ORIGINS="http://localhost:3000,https://yourdomain.com"
ADMIN_TOKEN="your_admin_token_here"
VALID_API_KEYS="key1,key2,key3"
```

### ã‚µãƒ¼ãƒãƒ¼èµ·å‹•

```bash
# é–‹ç™ºãƒ¢ãƒ¼ãƒ‰
npm run dev

# æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰
npm run build
npm start
```

### APIãƒ†ã‚¹ãƒˆ

```bash
# APIãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
chmod +x scripts/test-api.sh
./scripts/test-api.sh
```

## ğŸ“‹ APIä»•æ§˜

è©³ç´°ãªAPIä»•æ§˜ã¯ [API Documentation](../docs/api-documentation.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### ä¸»è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èª¬æ˜ |
|----------------|------|
| `GET /health` | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ |
| `POST /api/projects` | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ |
| `POST /api/analysis/projects/{id}/topics` | AIåˆ†æå®Ÿè¡Œ |
| `POST /api/public/projects/{userId}/{projectId}/opinions` | ãƒ‘ãƒ–ãƒªãƒƒã‚¯æ„è¦‹æŠ•ç¨¿ |
| `POST /api/analysis/consensus` | ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹ç”Ÿæˆ |

### WebSocket ã‚¤ãƒ™ãƒ³ãƒˆ

- `analysis_progress`: åˆ†æé€²æ—é€šçŸ¥
- `new_opinion`: æ–°è¦æ„è¦‹æŠ•ç¨¿é€šçŸ¥  
- `project_status_changed`: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ³å¤‰æ›´

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **Runtime**: Node.js + TypeScript
- **Framework**: Express.js
- **Database**: SQLite + Prisma ORM
- **AI Integration**: OpenAI API
- **Real-time**: Socket.IO
- **Security**: Helmet, CORS, ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
- **Monitoring**: ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
- **Logging**: æ§‹é€ åŒ–ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/          # (æœªä½¿ç”¨ - ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ä»£æ›¿)
â”‚   â”œâ”€â”€ middleware/           # ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
â”‚   â”‚   â”œâ”€â”€ auth.ts          # èªè¨¼
â”‚   â”‚   â”œâ”€â”€ errorHandler.ts  # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
â”‚   â”‚   â”œâ”€â”€ performance.ts   # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
â”‚   â”‚   â”œâ”€â”€ security.ts      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
â”‚   â”‚   â””â”€â”€ validator.ts     # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ routes/              # APIãƒ«ãƒ¼ãƒˆ
â”‚   â”‚   â”œâ”€â”€ analysis.ts      # åˆ†æAPI
â”‚   â”‚   â”œâ”€â”€ consensus.ts     # ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹API
â”‚   â”‚   â”œâ”€â”€ projects.db.ts   # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
â”‚   â”‚   â””â”€â”€ public.ts        # ãƒ‘ãƒ–ãƒªãƒƒã‚¯API
â”‚   â”œâ”€â”€ services/            # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ aiService.ts                # AIçµ±åˆ
â”‚   â”‚   â”œâ”€â”€ consensusService.enhanced.ts # å¼·åŒ–ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹
â”‚   â”‚   â”œâ”€â”€ opinionService.db.ts        # æ„è¦‹ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ projectService.db.ts        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
â”‚   â”‚   â”œâ”€â”€ realtimeService.ts          # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡
â”‚   â”‚   â”œâ”€â”€ taskService.db.ts           # ã‚¿ã‚¹ã‚¯ç®¡ç†
â”‚   â”‚   â””â”€â”€ topicAnalysisService.ts     # ãƒˆãƒ”ãƒƒã‚¯åˆ†æ
â”‚   â”œâ”€â”€ types/               # å‹å®šç¾©
â”‚   â”œâ”€â”€ utils/               # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â””â”€â”€ logger.ts        # ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”œâ”€â”€ lib/                 # ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
â”‚   â”‚   â””â”€â”€ database.ts      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
â”‚   â”œâ”€â”€ index.db.ts          # é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼
â”‚   â””â”€â”€ index.production.ts  # æœ¬ç•ªç”¨ã‚µãƒ¼ãƒãƒ¼
â”œâ”€â”€ prisma/                  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
â”‚   â”œâ”€â”€ schema.prisma        # ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”‚   â””â”€â”€ seed.ts             # ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
â”œâ”€â”€ scripts/                 # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ logs/                    # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
â””â”€â”€ docs/                    # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

## ğŸ”§ é–‹ç™º

### npm scripts

```bash
# é–‹ç™º
npm run dev              # é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run build           # ãƒ“ãƒ«ãƒ‰
npm run start           # æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼èµ·å‹•

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
npm run db:generate     # Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ
npm run db:push         # ã‚¹ã‚­ãƒ¼ãƒã‚’DBã«ãƒ—ãƒƒã‚·ãƒ¥
npm run db:migrate      # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
npm run db:seed         # ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
npm run db:studio       # Prisma Studioèµ·å‹•

# å“è³ªç®¡ç†
npm run lint            # ESLintå®Ÿè¡Œ
npm run test            # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (è¨­å®šå¿…è¦)
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆ
npm run db:push

# ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å†æŠ•å…¥
npm run db:seed

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒç¢ºèª
npm run db:studio
```

## ğŸ³ Docker

### Docker Composeä½¿ç”¨

```bash
# æœ¬ç•ªç’°å¢ƒ
docker-compose up -d

# é–‹ç™ºç’°å¢ƒ
docker-compose --profile dev up -d
```

### å˜ä½“Dockerä½¿ç”¨

```bash
# ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
docker build -t consensus-ai-backend .

# ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œ
docker run -p 3000:3000 -e OPENAI_API_KEY=your_key consensus-ai-backend
```

## ğŸ“Š ç›£è¦–ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

- `GET /health` - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- `GET /api/system/info` - ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±
- `GET /api/metrics` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- `GET /api/realtime/stats` - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆ

### ãƒ­ã‚°

ãƒ­ã‚°ã¯ `logs/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»¥ä¸‹ã®å½¢å¼ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼š

- `combined.log` - å…¨ãƒ¬ãƒ™ãƒ«ã®ãƒ­ã‚°
- `error-YYYY-MM-DD.log` - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
- `warn-YYYY-MM-DD.log` - è­¦å‘Šãƒ­ã‚°
- `info-YYYY-MM-DD.log` - æƒ…å ±ãƒ­ã‚°

### Prometheusçµ±åˆ

```bash
# Prometheuså½¢å¼ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—
curl http://localhost:3000/api/metrics?format=prometheus
```

## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½

- **å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**: XSSæ”»æ’ƒé˜²æ­¢
- **SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: APIåˆ¥ã®åˆ¶é™è¨­å®š
- **CORSè¨­å®š**: ã‚ªãƒªã‚¸ãƒ³åˆ¶é™
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼**: Helmet.jsä½¿ç”¨
- **ä¸å¯©ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ¤œå‡º**: è‡ªå‹•ç›£è¦–

### æœ¬ç•ªç’°å¢ƒã§ã®è¨­å®š

```env
# è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã‚’æŒ‡å®š
ALLOWED_ORIGINS="https://yourdomain.com"

# ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³
ADMIN_TOKEN="secure_random_token"

# APIã‚­ãƒ¼
VALID_API_KEYS="key1,key2,key3"
```

## ğŸ”„ ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥å®Ÿè£…çŠ¶æ³

| ãƒ•ã‚§ãƒ¼ã‚º | çŠ¶æ³ | å†…å®¹ |
|----------|------|------|
| ãƒ•ã‚§ãƒ¼ã‚º1 | âœ… å®Œäº† | åŸºæœ¬çš„ãªAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| ãƒ•ã‚§ãƒ¼ã‚º2 | âœ… å®Œäº† | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æºã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ– |
| ãƒ•ã‚§ãƒ¼ã‚º3 | âœ… å®Œäº† | AIçµ±åˆã¨ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹åˆ†ææ©Ÿèƒ½ |
| ãƒ•ã‚§ãƒ¼ã‚º4 | âœ… å®Œäº† | çµ±åˆãƒ†ã‚¹ãƒˆã¨æœ€é©åŒ– |

è©³ç´°ãªé€²æ—ã¯ [backend-progress.md](../docs/backend-progress.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ğŸ§ª ãƒ†ã‚¹ãƒˆ

### è‡ªå‹•ãƒ†ã‚¹ãƒˆ

```bash
# APIãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
./scripts/test-api.sh

# å€‹åˆ¥ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
curl http://localhost:3000/health
```

### æ‰‹å‹•ãƒ†ã‚¹ãƒˆæ‰‹é †

1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
3. æ„è¦‹æŠ•ç¨¿
4. åˆ†æå®Ÿè¡Œ
5. ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹ç”Ÿæˆ

## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [API Documentation](../docs/api-documentation.md) - è©³ç´°ãªAPIä»•æ§˜
- [Backend Progress](../docs/backend-progress.md) - å®Ÿè£…é€²æ—
- [Backend Implementation Plan](../docs/backend-implementation-plan.md) - å®Ÿè£…è¨ˆç”»

## ğŸ¤ è²¢çŒ®

1. Fork the repository
2. Create your feature branch
3. Commit your changes
4. Push to the branch
5. Create a Pull Request

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

[ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã‚’ã“ã“ã«è¨˜è¼‰]

## ğŸ†˜ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆï¼š

1. [API Documentation](../docs/api-documentation.md) ã‚’ç¢ºèª
2. `logs/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ­ã‚°ã‚’ç¢ºèª
3. `GET /health` ã§ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèª
4. Issueä½œæˆ

---

**ConsensusAI Backend** - AIçµ±åˆã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹å½¢æˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 